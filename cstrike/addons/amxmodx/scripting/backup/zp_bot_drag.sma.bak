/* Plugin generated by AMXX-Studio */

#include <amxmodx>
#include <fakemeta>
#include <hamsandwich>
#include <engine>
#include <zombieplague>

#define PLUGIN "New Plug-In"
#define VERSION "1.0"
#define AUTHOR "author"

new bool: g_has_drag[33],g_Line,g_hooked[33], bool: g_drag_i[33], g_unable2move[33]
public plugin_init()
{
	RegisterHam(Ham_Spawn, "player", "fw_spawn_post", 1)
	register_event("DeathMsg", "player_death", "a")
	register_clcmd("+drag","drag_start")
	register_clcmd("-drag","drag_end")
	
}
public plugin_precache()
{
	g_Line = precache_model("sprites/zbeam4.spr")
}
public fw_spawn_post(id)
{
	g_has_drag[id] = true
}
public player_death()
{
	new attacker = read_data(1)
	new id = read_data(2)
	
	if (g_hooked[attacker])
		drag_end(id)
}
public drag_start(id)
{		
	if (g_has_drag[id] && !g_drag_i[id]) 
	{
		new hooktarget, body
		get_user_aiming(id, hooktarget, body)
		
		if (is_user_alive(hooktarget)) 
		{
			g_hooked[id] = hooktarget

			new parm[2]
			parm[0] = id
			parm[1] = hooktarget
			
			set_task(0.1, "reelin_player", id, parm, 2, "b")
			harpoon_target(parm)
			
			zp_disinfect_user(hooktarget)
			
			g_drag_i[id] = true
			g_unable2move[hooktarget] = true

		} else {
			g_hooked[id] = 33
			noTarget(id)
			g_drag_i[id] = true
		}
	}
	else
		return PLUGIN_HANDLED
	
	return PLUGIN_CONTINUE
}

public reelin_player(parm[])
{
	new id = parm[0]
	new victim = parm[1]

	if (!g_hooked[id] || !is_user_alive(victim))
	{
		drag_end(id)
		return
	}

	new Float:fl_Velocity[3]
	new idOrigin[3], vicOrigin[3]

	get_user_origin(victim, vicOrigin)
	get_user_origin(id, idOrigin)

	new distance = get_distance(idOrigin, vicOrigin)

	if (distance > 1) {
		new Float:fl_Time = distance / 1300.0

		fl_Velocity[0] = (idOrigin[0] - vicOrigin[0]) / fl_Time
		fl_Velocity[1] = (idOrigin[1] - vicOrigin[1]) / fl_Time
		fl_Velocity[2] = (idOrigin[2] - vicOrigin[2]) / fl_Time
	} else {
		fl_Velocity[0] = 0.0
		fl_Velocity[1] = 0.0
		fl_Velocity[2] = 0.0
	}
	entity_set_vector(victim, EV_VEC_velocity, fl_Velocity)
}

public drag_end(id)
{
	g_hooked[id] = 0
	beam_remove(id)
	remove_task(id)

	g_drag_i[id] = false
	g_unable2move[id] = false
}
public harpoon_target(parm[])
{
	new id = parm[0]
	new hooktarget = parm[1]

	message_begin(MSG_BROADCAST, SVC_TEMPENTITY)
	write_byte(8)
	write_short(id)
	write_short(hooktarget)
	write_short(g_Line)
	write_byte(0)
	write_byte(0)
	write_byte(200)
	write_byte(8)
	write_byte(1)
	write_byte(255)
	write_byte(0)
	write_byte(0)
	write_byte(90)
	write_byte(10)
	message_end()
}

public noTarget(id)
{
	new endorigin[3]

	get_user_origin(id, endorigin, 3)

	message_begin(MSG_BROADCAST, SVC_TEMPENTITY)
	write_byte( TE_BEAMENTPOINT );
	write_short(id)
	write_coord(endorigin[0])
	write_coord(endorigin[1])
	write_coord(endorigin[2])
	write_short(g_Line)
	write_byte(0)
	write_byte(0)
	write_byte(200)
	write_byte(8)
	write_byte(1)
	write_byte(255)
	write_byte(0)
	write_byte(0)
	write_byte(75)
	write_byte(0)
	message_end()
}

public beam_remove(id)
{
	message_begin(MSG_BROADCAST, SVC_TEMPENTITY)
	write_byte(99)
	write_short(id)
	message_end()
}
